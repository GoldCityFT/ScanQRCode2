<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
 <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      margin-bottom: 20px;
      font-size: 2rem;
      text-align: center;
    }

    form {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 5px 10px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1rem;
      box-sizing: border-box;
    }

    button {
      margin-top: 20px;
      width: 100%;
      padding: 12px;
      background: #00C300;
      border: none;
      border-radius: 5px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }

    button:hover {
      background: #009f2b;
    }

    /* Modal popup */
    #modal {
      display: none;
      position: fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #modal div {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 300px;
      width: 90%;
      box-sizing: border-box;
    }

    /* Responsive ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    @media (max-width: 768px) {
      h2 {
        font-size: 1.8rem;
      }
      form {
        padding: 15px;
        max-width: 90%;
      }
      input, select, button {
        font-size: 1rem;
        padding: 10px;
      }
      #modal div {
        padding: 15px;
      }
    }


   form {
  display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô */
  background: white;
  padding: 20px;
  border-radius: 10px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 5px 10px rgba(0,0,0,0.1);
  box-sizing: border-box;
}

   
  </style>
</head>
<body>
<h2>‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</h2>

<form id="surveyForm" action="https://script.google.com/macros/s/AKfycbyklv9SQB7L2WdrTjHRuwZkm9UB0zime9s8v8gutC2p3VcVPQB1Pd3I8rZoQA_v63zx/exec" method="POST" target="hidden_iframe">
  <input type="hidden" name="token" value="Gl0D$Yt1@">
  <input type="hidden" id="UserId" name="UserId">
  <input type="hidden" id="Tracking" name="Tracking">

  <label>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• </label>
  <input type="text" name="DisplayName" required placeholder="‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏">

  <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
  <input type="text" name="Location" >

  
 <!-- 
  <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
  <input type="number" name="Phone" required placeholder="‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏">  
 -->

  <label>‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
  <input type="text" name="PostCode" required placeholder="‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏">

  <label>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label>
  <select id="itemSelect" name="ItemName" required>
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
    <option value="‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏ï‡∏∞">‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏ï‡∏∞</option>
    <option value="‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ú‡πâ‡∏≤‡πÉ‡∏ö">‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ú‡πâ‡∏≤‡πÉ‡∏ö</option>
  </select>

  <label>‡∏™‡∏µ</label>
  <select id="colorSelect" name="Color" required>
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ --</option>
  </select>

  <label>‡∏Ç‡∏ô‡∏≤‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
  <select name="Size">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î --</option>
    <option value="39">39</option>
    <option value="40">40</option>
    <option value="41">41</option>
    <option value="42">42</option>
    <option value="43">43</option>
    <option value="44">44</option>
    <option value="45">45</option>
  </select>
  
 <!-- 
  <label>Invoice (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
  <input type="text" name="Invoice" placeholder="‡πÄ‡∏ä‡πà‡∏ô INV1234">
-->
  
  <button type="submit">Submit</button>
</form>

<!-- ‡πÉ‡∏ä‡πâ iframe ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà -->
<iframe name="hidden_iframe" style="display:none;"></iframe>

<!-- popup modal -->
<div id="modal" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
  z-index:1000;
">
  <div style="
    background:white;
    padding:20px;
    border-radius:10px;
    text-align:center;
    max-width:300px;
  ">
    
    <p>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
    <button id="okBtn">OK</button>
  </div>
</div>
 <!-- popup ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà -->
<div id="loadingModal" style="
  display:flex;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  justify-content:center;
  align-items:center;
  z-index:2000;
">
  <div style="
    background:white;
    padding:4vw;            /* ‡πÉ‡∏ä‡πâ vw ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
    border-radius:2vw;
    text-align:center;
    max-width:90%;          /* ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 90% ‡∏Ç‡∏≠‡∏á‡∏à‡∏≠ */
    width:90%;
    font-size:4vw;          /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≠ */
    box-sizing:border-box;
  ">
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
  </div>
</div>
<script>
let isSubmitted = false;

const itemSelect = document.getElementById("itemSelect");
const colorSelect = document.getElementById("colorSelect");
const form = document.getElementById("surveyForm");
const modal = document.getElementById("modal");
const okBtn = document.getElementById("okBtn");

const colorOptions = {
  "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏ï‡∏∞": ["‡∏î‡∏≥", "‡∏Ç‡∏≤‡∏ß"],
  "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ú‡πâ‡∏≤‡πÉ‡∏ö": ["‡πÅ‡∏î‡∏á", "‡∏î‡∏≥", "‡∏Ç‡∏≤‡∏ß", "‡∏Ñ‡∏£‡∏µ‡∏°", "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", "‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô"]
};

function updateColors() {
  const selectedItem = itemSelect.value;
  colorSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ --</option>';
  if(selectedItem && colorOptions[selectedItem]){
    colorOptions[selectedItem].forEach(color => {
      const option = document.createElement("option");
      option.value = color;
      option.textContent = color;
      colorSelect.appendChild(option);
    });
  }
}
itemSelect.addEventListener("change", updateColors);

async function main() {
  const loadingModal = document.getElementById("loadingModal");
 
 try {
    console.log("üü¢ ‡πÄ‡∏£‡∏¥‡πà‡∏° main()");
    await liff.init({ liffId: "2008187346-LZW3ndvO" });
    if (!liff.isLoggedIn()) {
      console.log("üî¥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà login -> redirect login");
      return liff.login();
    }

    const profile = await liff.getProfile();
    console.log("‚úÖ ‡πÑ‡∏î‡πâ profile:", profile.displayName);
    document.getElementById("UserId").value = profile.userId;

    const trackingCode = sessionStorage.getItem("tracking") || "";
    document.getElementById("Tracking").value = trackingCode;
    console.log("üì¶ Tracking:", trackingCode);

    if (!trackingCode) {
      loadingModal.style.display = "none";
      modal.querySelector("p").textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö QR Code ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏Å‡πà‡∏≠‡∏ô";
      modal.style.display = "flex";
      okBtn.onclick = () => {
        modal.style.display = "none";
        window.location.href = "ScanQrcode2.html";
      };
      return;
    }

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡∏Å‡πà‡∏≠‡∏ô
    const SECRET_TOKEN = "Gl0D$Yt1@";
    const GET_URL = `https://script.google.com/macros/s/AKfycbyklv9SQB7L2WdrTjHRuwZkm9UB0zime9s8v8gutC2p3VcVPQB1Pd3I8rZoQA_v63zx/exec?token=${SECRET_TOKEN}&UserId=${profile.userId}`;

    console.log("üåê Fetch:", GET_URL);
    const res = await fetch(GET_URL);
    const result = await res.json();
    console.log("‚úÖ result:", result);

    if (result.lastData) {
      const data = result.lastData;
      if (data.DisplayName) document.querySelector("input[name='DisplayName']").value = data.DisplayName;
      if (data.Location) document.querySelector("input[name='Location']").value = data.Location;
      if (data.PostCode) document.querySelector("input[name='PostCode']").value = data.PostCode;
    } else {
      // ‚ùó fallback ‡∏à‡∏≤‡∏Å sessionStorage
      const fallback = JSON.parse(sessionStorage.getItem("selectedRow") || "{}");
      document.querySelector("input[name='DisplayName']").value = fallback.CustomerName || "";
      document.querySelector("input[name='PostCode']").value = fallback.BillingPostCode || "";
      document.querySelector("input[name='Location']").value = fallback.BillingAddr || "";
    }
  } catch (err) {
    console.error("üö® main() error:", err);
    modal.querySelector("p").textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
    modal.style.display = "flex";
    okBtn.onclick = () => (modal.style.display = "none");
  } finally {
    console.log("üü° ‡∏ã‡πà‡∏≠‡∏ô loading ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°");
    loadingModal.style.display = "none";
    form.style.display = "block";
  }
}

main();

form.addEventListener("submit", function(event) {
  const selectedItem = itemSelect.value;
  const selectedColor = colorSelect.value;
  if(selectedItem && !selectedColor){
    event.preventDefault();
    modal.querySelector("p").textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö";
    modal.style.display = "flex";
    okBtn.onclick = () => { modal.style.display = "none"; };
    return;
  }

  event.preventDefault();
  isSubmitted = true;
  form.submit();
  modal.querySelector("p").textContent = "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
  modal.style.display = "flex";

  // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ input
  document.querySelector("input[name='DisplayName']").value = "";
  document.querySelector("input[name='Location']").value = "";
  document.querySelector("input[name='PostCode']").value = "";
  itemSelect.value = "";
  colorSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ --</option>';

  // ‡∏•‡πâ‡∏≤‡∏á tracking ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏•‡∏±‡∏á submit
  sessionStorage.removeItem('tracking');
});

// --- ‡∏™‡πà‡∏á UserId+Tracking ‡∏ñ‡πâ‡∏≤ user ‡∏õ‡∏¥‡∏î/‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö ---
document.addEventListener("visibilitychange", function() {
  if(!isSubmitted && document.visibilityState==="hidden"){
    const data = new FormData();
    data.append('token','Gl0D$Yt1@');
    data.append('UserId', document.getElementById('UserId').value);
    data.append('Tracking', document.getElementById('Tracking').value);
    navigator.sendBeacon("https://script.google.com/macros/s/AKfycbyklv9SQB7L2WdrTjHRuwZkm9UB0zime9s8v8gutC2p3VcVPQB1Pd3I8rZoQA_v63zx/exec", data);
  }
});

okBtn.addEventListener("click", () => {
  modal.style.display = "none";
  liff.closeWindow();
});
  
</script>
</body>
</html>
